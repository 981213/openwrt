From 4c6dceec5a938e197d79088354206dd44152cc92 Mon Sep 17 00:00:00 2001
From: Chuanhong Guo <gch981213@gmail.com>
Date: Tue, 27 Nov 2018 16:39:46 +0800
Subject: [PATCH 111/111] spi: spi-mt7621: drop support for SPI mode 1/2/3

All modes except mode0 are broken on this controller.

Signed-off-by: Chuanhong Guo <gch981213@gmail.com>
---
 drivers/spi/spi-mt7621.c | 23 ++++++++++-------------
 1 file changed, 10 insertions(+), 13 deletions(-)

diff --git a/drivers/spi/spi-mt7621.c b/drivers/spi/spi-mt7621.c
index 8af6f307..fb189e3c 100644
--- a/drivers/spi/spi-mt7621.c
+++ b/drivers/spi/spi-mt7621.c
@@ -137,19 +137,16 @@ static int mt7621_spi_prepare(struct spi_device *spi, unsigned int speed)
 		reg |= MT7621_LSB_FIRST;
 
 	reg &= ~(MT7621_CPHA | MT7621_CPOL);
-	switch (spi->mode & (SPI_CPOL | SPI_CPHA)) {
-	case SPI_MODE_0:
-		break;
-	case SPI_MODE_1:
-		reg |= MT7621_CPHA;
-		break;
-	case SPI_MODE_2:
-		reg |= MT7621_CPOL;
-		break;
-	case SPI_MODE_3:
-		reg |= MT7621_CPOL | MT7621_CPHA;
-		break;
-	}
+
+	/* This SPI controller is designed for SPI flash only and
+	 * some bits are swizzled under other SPI modes due to
+	 * incorrect wiring inside the silicon. Reject all modes
+	 * except mode0 because they are broken.
+	 */
+
+	if ((spi->mode & (SPI_CPOL | SPI_CPHA)) != SPI_MODE_0)
+		return -EINVAL;
+
 	mt7621_spi_write(rs, MT7621_SPI_MASTER, reg);
 
 	return 0;
-- 
2.19.1

